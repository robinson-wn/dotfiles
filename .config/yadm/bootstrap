#!/bin/bash

# --- 1. Boilerplate & Safety ---
set -e
set -u
set -o pipefail

# --- 2. Helpers ---
section() {
    echo "=== $* ==="
}

is_interactive() {
    [ -t 0 ]
}

apt_install() {
    sudo apt install -y "$@"
}

install_fzf_latest() {
    local fzf_version=$(curl -s https://api.github.com/repos/junegunn/fzf/releases/latest | grep -o '"tag_name": "[^"]*' | cut -d'"' -f4 | sed 's/v//')
    local fzf_url="https://github.com/junegunn/fzf/releases/download/v${fzf_version}/fzf-${fzf_version}-linux_amd64.tar.gz"
    
    if [ -z "$fzf_version" ]; then
        echo "Warning: Could not determine latest fzf version; skipping."
        return 1
    fi
    
    echo "Installing fzf v${fzf_version} from GitHub..."
    if curl -fsSL "$fzf_url" | tar -xz -C /tmp && sudo mv /tmp/fzf /usr/local/bin/fzf; then
        sudo chmod +x /usr/local/bin/fzf
        # Remove any apt-installed fzf to avoid conflicts
        sudo apt remove -y fzf >/dev/null 2>&1 || true
        # Ensure /usr/local/bin is in PATH and takes precedence
        echo "fzf installed: $(/usr/local/bin/fzf --version)"
        return 0
    else
        echo "Warning: Failed to install fzf from GitHub; falling back to apt."
        return 1
    fi
}

ensure_snap() {
    local pkg="$1"
    local cmd="${2:-$pkg}"
    local classic="${3:-}"

    command -v snap >/dev/null 2>&1 || return
    command -v "$cmd" >/dev/null 2>&1 && return

    local flag=""
    [ "$classic" = "--classic" ] && flag="--classic"
    sudo snap install "$pkg" $flag || true
}

install_optional_tool() {
    local pkg="$1"
    local snap_pkg="${2:-$pkg}"
    local classic="${3:-}"

    # Try apt first
    if sudo apt install -y "$pkg" 2>/dev/null; then
        return 0
    fi

    # Fall back to snap if apt fails
    echo "apt package '$pkg' not found; trying snap..."
    ensure_snap "$snap_pkg" "$pkg" "$classic"
}

run_script() {
    local path="$1"
    local label="$2"

    if [ ! -f "$path" ]; then
        echo "Skipping $label (not found)."
        return
    fi

    # Make executable if not already
    [ -x "$path" ] || chmod +x "$path"
    
    # Execute directly to respect shebang
    "$path" || echo "Warning: $label encountered errors."
}

update_zshenv() {
    local var_name="$1"
    local var_value="$2"
    local zshenv="$HOME/.zshenv"
    
    [ ! -f "$zshenv" ] && touch "$zshenv"
    
    # Remove old definition if exists
    sed -i "/^export ${var_name}=/d" "$zshenv"
    # Add new definition
    echo "export ${var_name}=${var_value}" >> "$zshenv"
}

maybe_run() {
    local path="$1"
    local label="$2"

    [ -f "$path" ] || return

    if is_interactive; then
        read -p "Run $label? (y/N): " response < /dev/tty || response="N"
        [[ "$response" =~ ^[Yy]$ ]] || { echo "Skipping $label."; return; }
    else
        echo "Running non-interactively. Skipping $label."
        return
    fi

    run_script "$path" "$label"
}

export NVM_DIR="$HOME/.nvm"

load_nvm() {
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
}

install_nvm() {
    if [ -d "$NVM_DIR" ]; then
        echo "NVM already present."
        return 0
    fi

    if curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash 2>/dev/null; then
        return 0
    fi

    echo "Warning: NVM installation failed; falling back to apt Node."
    return 1
}

ensure_node_via_nvm() {
    local version="${1:-22}"

    load_nvm
    if ! command -v nvm >/dev/null 2>&1; then
        echo "NVM is not available."
        return 1
    fi

    nvm install "$version" >/dev/null 2>&1 || nvm install "$version"
    nvm alias default "$version" >/dev/null 2>&1 || true
    nvm use default >/dev/null 2>&1 || true

    echo "Node via NVM: $(node -v 2>/dev/null || echo not found)"
    echo "npm: $(npm -v 2>/dev/null || echo not found)"
}

apt_node_fallback() {
    echo "Installing Node.js and npm via apt (fallback)..."
    apt_install nodejs npm

    if ! command -v node >/dev/null 2>&1 && command -v nodejs >/dev/null 2>&1; then
        sudo ln -sf "$(command -v nodejs)" /usr/bin/node
    fi

    if command -v node >/dev/null 2>&1; then
        echo "Node.js (apt): $(node -v)"
        echo "npm (apt): $(npm -v || echo missing)"
    else
        echo "Warning: Node.js installation via apt did not provide 'node' binary."
    fi
}

maybe_configure_java() {
    if ! command -v update-alternatives >/dev/null 2>&1; then
        return
    fi

    if ! sudo update-alternatives --list java >/dev/null 2>&1; then
        return
    fi

    if is_interactive; then
        read -p "Configure default Java version? (y/N): " response < /dev/tty || response="N"
        if [[ "$response" =~ ^[Yy]$ ]]; then
            sudo update-alternatives --config java
        fi
    else
        echo "Non-interactive: skipping Java version configuration."
    fi
    
    # Update .zshenv with the selected JAVA_HOME
    local java_home=$(update-alternatives --query java 2>/dev/null | grep -oP 'Current: \K.*(?=/bin/java)' || true)
    if [ -z "$java_home" ]; then
        # Fallback detection
        for path in /usr/lib/jvm/java-17-openjdk-amd64 /usr/lib/jvm/java-21-openjdk-amd64 /usr/lib/jvm/default-java; do
            if [ -d "$path" ]; then
                java_home="$path"
                break
            fi
        done
    fi
    
    if [ -n "$java_home" ]; then
        echo "Setting JAVA_HOME=$java_home in ~/.zshenv"
        update_zshenv "JAVA_HOME" "$java_home"
    fi
}

ensure_winget_app() {
    local id="$1"
    local label="$2"

    if ! command -v cmd.exe >/dev/null 2>&1; then
        return
    fi

    if cmd.exe /c "winget list --id $id" >/dev/null 2>&1; then
        echo "$label is already installed."
    else
        cmd.exe /c "winget install --id $id --silent --accept-package-agreements --accept-source-agreements --wait" || \
            echo "Warning: $label installation via winget failed."
    fi
}

# --- 3. OS Check ---
if [ ! -f /etc/debian_version ]; then
    echo "Error: This bootstrap script is tailored for Debian/Ubuntu."
    exit 1
fi

# --- 4. Repositories & Updates ---
section "Updating package sources"
sudo apt update
sudo apt upgrade -y
sudo apt autoremove -y

# --- 5. Core Packages ---
section "Installing base packages"
echo "Note: Java 17 is recommended for Apache Spark compatibility."
apt_install \
    openjdk-17-jdk maven \
    zsh build-essential btop curl file git duf eza \
    yadm bat direnv wget yamllint \
    libsecret-1-dev lsb-release \
    ca-certificates gnupg snapd

# --- 5b. Install fzf from latest GitHub release ---
install_fzf_latest || apt_install fzf

# --- 6. Node.js (NVM-first) ---
section "Installing Node.js via NVM"
install_nvm && ensure_node_via_nvm 22 || apt_node_fallback

# --- 7. Java alternatives ---
maybe_configure_java

# --- 8. Optional packages (apt with snap fallback) ---
section "Installing optional packages"
install_optional_tool gh gh
install_optional_tool glab glab
install_optional_tool kubectl kubectl --classic
install_optional_tool kubectx kubectx
install_optional_tool starship starship
install_optional_tool zoxide zoxide
install_optional_tool dust dust

# --- 9. Tool-specific scripts ---
section "Running local setup scripts"
required_scripts=(
    "$HOME/.local/bin/minconda_install.sh:Miniconda install"
    "$HOME/.local/bin/python_interps.sh:Python interpreters setup"
    "$HOME/.local/bin/nerd_fonts_install.sh:Nerd Fonts install"
)

optional_scripts=(
    "$HOME/.local/bin/ollama_install.sh:Ollama"
    "$HOME/.local/bin/spark_install.sh:Spark"
    "$HOME/.local/bin/gcloud_install_init.sh:Google Cloud SDK"
)

for entry in "${required_scripts[@]}"; do
    path=${entry%%:*}
    label=${entry#*:}
    run_script "$path" "$label"
done

for entry in "${optional_scripts[@]}"; do
    path=${entry%%:*}
    label=${entry#*:}
    maybe_run "$path" "$label"
done

# --- 11. Windows interop (WSL) ---
if [ -d "/mnt/c/Windows" ] || command -v cmd.exe >/dev/null 2>&1; then
    section "WSL: checking Windows installs via winget"

    ensure_winget_app Microsoft.VisualStudioCode "VS Code"

    if command -v cmd.exe >/dev/null 2>&1; then
        if ! cmd.exe /c "where docker" >/dev/null 2>&1; then
            if is_interactive; then
                read -p "Install Docker Desktop? (y/N): " response < /dev/tty || response="N"
                if [[ "$response" =~ ^[Yy]$ ]]; then
                    cmd.exe /c "winget install --id Docker.DockerDesktop --silent --accept-package-agreements --accept-source-agreements --wait" || \
                        echo "Warning: Docker Desktop installation via winget failed."
                    echo ""
                    echo "=== Docker Desktop Installation Complete ==="
                    echo "IMPORTANT: Restart Windows for Docker to function."
                else
                    echo "Skipping Docker Desktop installation."
                fi
            else
                echo "Non-interactive: skipping Docker Desktop installation."
            fi
        else
            echo "Docker is already installed."
        fi
    fi
fi

# --- 12. Final configs & shell ---
section "Final configuration"
git config --global core.excludesfile "$HOME/.config/git/ignore" || echo "Warning: Failed to set git config."

if command -v zsh >/dev/null 2>&1; then
    current_shell=$(getent passwd "$USER" | cut -d: -f7)
    zsh_path=$(command -v zsh)

    if [ "$current_shell" != "$zsh_path" ]; then
        echo "Changing your default shell to zsh..."
        if sudo chsh -s "$zsh_path" "$USER"; then
            echo "Shell successfully changed to zsh."
        else
            echo "Warning: Failed to change shell. You may need to run 'chsh -s $(which zsh)' manually."
        fi
    else
        echo "Default shell is already zsh."
    fi
else
    echo "Warning: zsh not found. Please install it manually before continuing."
fi

echo "--------------------------------------------------"
echo "Bootstrap complete!"
echo "Please RESTART your terminal (or log out and back in) to use ZSH."
echo ""
echo "WSL Ubuntu 24.x Note:"
echo "If you want to use snap packages, ensure systemd is enabled in WSL:"
echo "  Add 'systemd=true' to /etc/wsl.conf and restart WSL"
echo "--------------------------------------------------"
