#!/bin/bash

# --- 1. Boilerplate & Safety ---
set -e          # Exit immediately if a command fails
set -u          # Treat unset variables as an error
set -o pipefail # Return exit code of the last command in a pipe that failed

# Ensure we have sudo early
echo "Requesting administrative privileges..."
sudo -v
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# --- 2. OS Check ---
if [ ! -f /etc/debian_version ]; then
    echo "Error: This bootstrap script is tailored for Debian/Ubuntu."
    exit 1
fi

# --- 3. Repositories & Updates ---
echo "--- Updating Package Sources ---"
if [ ! -f /usr/share/keyrings/helm.gpg ]; then
    if curl -fsSL --fail --max-time 10 https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null 2>&1; then
        echo "deb [signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list > /dev/null
    else
        echo "Warning: Failed to add Helm repository. Continuing without it."
    fi
fi

if [ ! -f /usr/share/keyrings/kubernetes-archive-keyring.gpg ]; then
    if curl -fsSL --fail --max-time 10 https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor | sudo tee /usr/share/keyrings/kubernetes-archive-keyring.gpg > /dev/null 2>&1; then
        echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list > /dev/null
    else
        echo "Warning: Failed to add Kubernetes repository. Continuing without it."
    fi
fi

if [ ! -f /usr/share/keyrings/githubcli-archive-keyring.gpg ]; then
    if curl -fsSL --fail --max-time 10 https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /usr/share/keyrings/githubcli-archive-keyring.gpg > /dev/null 2>&1; then
        echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    else
        echo "Warning: Failed to add GitHub CLI repository. Continuing without it."
    fi
fi

if [ ! -f /usr/share/keyrings/gitlab-cli-archive-keyring.gpg ]; then
    if curl -fsSL --fail --max-time 10 https://gitlab.com/gitlab-org/cli/-/raw/main/build/ubuntu/keyring.gpg.d/gitlab-cli-archive-keyring.gpg | sudo tee /usr/share/keyrings/gitlab-cli-archive-keyring.gpg > /dev/null 2>&1; then
        echo "deb [signed-by=/usr/share/keyrings/gitlab-cli-archive-keyring.gpg] https://gitlab.com/gitlab-org/cli/-/releases/latest/downloads/apt stable main" | sudo tee /etc/apt/sources.list.d/gitlab-cli.list > /dev/null
    else
        echo "Warning: Failed to add GitLab CLI repository. Continuing without it."
    fi
fi

sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y

# --- 4. Package Installations ---
echo "--- Installing APT Packages ---"
sudo apt install -y \
    openjdk-17-jdk openjdk-21-jdk maven \
    zsh build-essential btop curl file git duf eza \
    gh glab yadm bat direnv wget yamllint \
    kubectl kubectx \
    libsecret-1-dev lsb-release

# --- 5. Install tools from GitHub releases ---
echo "--- Installing CLI tools from GitHub releases ---"
install_from_github() {
    local tool=$1
    local repo=$2
    local asset_pattern=$3
    
    if ! command -v "$tool" >/dev/null 2>&1; then
        echo "Installing $tool from GitHub..."
        
        # Get latest release download URL
        local download_url=$(curl -s "https://api.github.com/repos/$repo/releases/latest" | \
            grep -o '"browser_download_url": "[^"]*"' | \
            grep "$asset_pattern" | \
            head -1 | cut -d'"' -f4)
        
        if [ -z "$download_url" ]; then
            echo "Warning: Could not find download URL for $tool. Trying apt fallback..."
            if sudo apt install -y "$tool" 2>/dev/null; then
                echo "Installed $tool via apt"
            else
                echo "Warning: Failed to install $tool via apt as well"
            fi
            return
        fi
        
        # Download and install
        if curl -fsSL --max-time 30 "$download_url" | tar xz -C /usr/local/bin/ 2>/dev/null; then
            echo "Installed $tool"
        else
            echo "Warning: Failed to install $tool from GitHub. Trying apt fallback..."
            if sudo apt install -y "$tool" 2>/dev/null; then
                echo "Installed $tool via apt"
            else
                echo "Warning: Failed to install $tool via apt as well"
            fi
        fi
    fi
}

install_from_github "zoxide" "ajeetdsouza/zoxide" "x86_64-unknown-linux-musl"
install_from_github "starship" "starship/starship" "x86_64-unknown-linux-gnu"
install_from_github "dust" "bootandy/dust" "x86_64-unknown-linux-gnu"

echo "--- Configuring Java Version ---"
if command -v update-alternatives >/dev/null && sudo update-alternatives --list java >/dev/null 2>&1; then
    read -p "Configure default Java version? (y/N): " response < /dev/tty
    if [[ "$response" =~ ^[Yy]$ ]]; then
        sudo update-alternatives --config java
    fi
fi

# --- 6. Tool-Specific Installs ---
if [ ! -d "$HOME/.fzf" ]; then
    if git clone --depth 1 https://github.com/junegunn/fzf.git "$HOME/.fzf" 2>/dev/null; then
        "$HOME/.fzf/install" --no-update-rc --no-bash --no-fish --no-zsh 2>/dev/null || true
    else
        echo "Warning: Failed to clone fzf repository. Continuing without it."
    fi
fi

run_opt_script() {
    local script_path="$1"
    local script_name="$2"
    if [ -f "$script_path" ]; then
        read -p "Do you want to run $script_name? (y/N): " response < /dev/tty
        if [[ "$response" =~ ^[Yy]$ ]]; then
            if command -v zsh >/dev/null; then
                zsh "$script_path" || echo "Warning: $script_name encountered errors."
            else
                bash "$script_path" || echo "Warning: $script_name encountered errors."
            fi
        fi
    else
        echo "Warning: Script $script_path not found. Skipping $script_name."
    fi
}

echo "--- Installing Optional Tools ---"
for script in minconda_install.sh python_interps.sh ollama_install.sh nerd_fonts_install.sh; do
    if [ -f "$HOME/.local/bin/$script" ]; then
        if command -v zsh >/dev/null; then
            zsh "$HOME/.local/bin/$script" || echo "Warning: $script encountered errors."
        else
            bash "$HOME/.local/bin/$script" || echo "Warning: $script encountered errors."
        fi
    fi
done

run_opt_script "$HOME/.local/bin/spark_install.sh" "Spark"
run_opt_script "$HOME/.local/bin/gcloud_install_init.sh" "Google Cloud"

# --- 7. Windows Interop (VS Code & Docker) ---
if [ -d "/mnt/c/Windows" ] || command -v cmd.exe >/dev/null 2>&1; then
    echo "--- Detected WSL: Checking Windows Installs via winget ---"
    if ! cmd.exe /c "winget list --id Microsoft.VisualStudioCode" >/dev/null 2>&1; then
        cmd.exe /c "winget install --id Microsoft.VisualStudioCode --silent --accept-package-agreements --accept-source-agreements" || echo "Warning: VS Code installation via winget failed."
    fi

    if ! cmd.exe /c "where docker" >/dev/null 2>&1; then
        read -p "Do you want to install Docker Desktop? (y/N): " response < /dev/tty
        if [[ "$response" =~ ^[Yy]$ ]]; then
            echo "Installing Docker Desktop..."
            if cmd.exe /c "winget install --id Docker.DockerDesktop --silent --accept-package-agreements --accept-source-agreements --wait"; then
                echo ""
                echo "=== Docker Desktop Installation Complete ==="
                echo "IMPORTANT: Manual steps required for Docker to work:"
                echo "  1. RESTART Windows (required for Docker to function)"
                echo "  2. After restart, launch Docker Desktop from Start Menu"
                echo "  3. Accept the Docker service agreement"
                echo "  4. Wait for Docker to fully start (whale icon in system tray)"
                echo "  5. Enable WSL 2 integration:"
                echo "     - Open Docker Desktop Settings"
                echo "     - Go to General > Enable 'Use the WSL 2 based engine'"
                echo "     - Go to Resources > WSL Integration"
                echo "     - Enable integration for your WSL distributions"
                echo "  6. Verify from WSL after setup: docker --version"
                echo ""
            else
                echo "Warning: Docker Desktop installation via winget failed."
            fi
        else
            echo "Skipping Docker Desktop installation."
        fi
    fi
fi

# --- 8. Final Configs & Shell Switch ---
git config --global core.excludesfile "$HOME/.config/git/ignore" || echo "Warning: Failed to set git config."

# Switch default shell to zsh if it isn't already
if command -v zsh >/dev/null; then
    CURRENT_SHELL=$(getent passwd "$USER" | cut -d: -f7)
    ZSH_PATH=$(command -v zsh)
    
    if [ "$CURRENT_SHELL" != "$ZSH_PATH" ]; then
        echo "Changing your default shell to zsh..."
        if sudo chsh -s "$ZSH_PATH" "$USER"; then
            echo "Shell successfully changed to zsh."
        else
            echo "Warning: Failed to change shell. You may need to run 'chsh -s \$(which zsh)' manually."
        fi
    else
        echo "Default shell is already set to zsh."
    fi
else
    echo "Warning: zsh not found. Please install it manually before continuing."
fi

echo "--------------------------------------------------"
echo "Bootstrap complete!"
echo "Please RESTART your terminal (or log out and back in) to use ZSH."
echo "--------------------------------------------------"
