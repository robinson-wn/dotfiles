#!/bin/bash

# --- 1. Boilerplate & Safety ---
set -e          # Exit immediately if a command fails
set -u          # Treat unset variables as an error
set -o pipefail # Return exit code of the last command in a pipe that failed

# Ensure we have sudo early
echo "Requesting administrative privileges..."
sudo -v
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# --- 2. OS Check ---
if [ ! -f /etc/debian_version ]; then
    echo "Error: This bootstrap script is tailored for Debian/Ubuntu."
    exit 1
fi

# --- 3. Repositories & Updates ---
echo "--- Updating Package Sources ---"
if [ ! -f /usr/share/keyrings/helm.gpg ]; then
    curl -fsSL --fail https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
    echo "deb [signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
fi

sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y

# --- 4. Homebrew ---
if ! command -v brew >/dev/null; then
    if [ -f "$HOME/.local/bin/homebrew_install.sh" ]; then
        bash "$HOME/.local/bin/homebrew_install.sh"
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    fi
fi

# --- 5. Package Installations ---
echo "--- Installing APT Packages ---"
sudo apt install -y \
    openjdk-17-jdk openjdk-21-jdk maven \
    zsh build-essential btop curl file git duf eza \
    gh glab yadm bat direnv wget yamllint zoxide \
    kubectl kubectx

# --- 6. Interactive Java Selection ---
echo "--- Configuring Java Version ---"
# This will open the interactive menu for the user to choose their preferred JDK
sudo update-alternatives --config java

echo "--- Installing Brew Packages ---"
if command -v brew >/dev/null; then
    brew install bottom dust starship
fi

# --- 7. Tool-Specific Installs ---
if [ ! -d "$HOME/.fzf" ]; then
    git clone --depth 1 https://github.com/junegunn/fzf.git "$HOME/.fzf"
    "$HOME/.fzf/install" --no-update-rc --no-bash --no-fish
fi

run_opt_script() {
    local script_path="$1"
    local script_name="$2"
    if [ -f "$script_path" ]; then
        read -p "Do you want to run $script_name? (y/N): " response < /dev/tty
        if [[ "$response" =~ ^[Yy]$ ]]; then
            bash "$script_path"
        fi
    else
        echo "Warning: Script $script_path not found. Skipping $script_name."
    fi
}

for script in minconda_install.sh python_interps.sh ollama_install.sh nerd_fonts_install.sh; do
    [[ -f "$HOME/.local/bin/$script" ]] && bash "$HOME/.local/bin/$script"
done

run_opt_script "$HOME/.local/bin/spark_install.sh" "Spark"
run_opt_script "$HOME/.local/bin/gcloud_install_init.sh" "Google Cloud"

# --- 8. Windows Interop (VS Code & Docker) ---
if command -v cmd.exe >/dev/null; then
    echo "--- Checking Windows Installs via winget ---"
    if ! cmd.exe /c "winget list --id Microsoft.VisualStudioCode" >/dev/null 2>&1; then
        cmd.exe /c "winget install --id Microsoft.VisualStudioCode --silent --accept-package-agreements --accept-source-agreements"
    fi

    if ! cmd.exe /c "where docker" >/dev/null 2>&1; then
        cmd.exe /c "winget install --id Docker.DockerDesktop --silent --accept-package-agreements --accept-source-agreements --wait"
    fi
fi

# --- 9. Final Configs & Shell Switch ---
git config --global core.excludesfile "$HOME/.config/git/ignore"

# Switch default shell to zsh if it isn't already
CURRENT_SHELL=$(getent passwd "$USER" | cut -d: -f7)
ZSH_PATH=$(command -v zsh)

if [ "$CURRENT_SHELL" != "$ZSH_PATH" ]; then
    echo "Changing your default shell to zsh..."
    sudo chsh -s "$ZSH_PATH" "$USER"
fi

echo "--------------------------------------------------"
echo "Bootstrap complete!"
echo "Please RESTART your terminal (or log out and back in) to use ZSH."
echo "--------------------------------------------------"
