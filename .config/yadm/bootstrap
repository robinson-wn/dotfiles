#!/bin/bash

# --- 1. Boilerplate & Safety ---
set -e
set -u
set -o pipefail

# --- 2. Helpers ---
log() { printf '%s\n' "$*"; }
warn() { printf 'Warning: %s\n' "$*" >&2; }

section() {
    log "=== $* ==="
}

is_interactive() {
    [ -t 0 ]
}

apt_install() {
    sudo apt install -y "$@"
}

install_fzf_from_github() {
    local target="$HOME/.fzf"

    # Update existing clone or fetch fresh
    if [ -d "$target/.git" ]; then
        git -C "$target" pull --ff-only || { warn "Failed to update fzf clone."; return 1; }
    else
        git clone --depth 1 https://github.com/junegunn/fzf.git "$target" || { warn "Failed to clone fzf."; return 1; }
    fi

    # Install bindings/completions without touching bash/fish rc files
    if "$target/install" --all --no-bash --no-fish --no-update-rc; then
        log "fzf installed from GitHub. Add shell sourcing if missing."
    else
        warn "fzf install script reported a failure."
        return 1
    fi
}

run_script() {
    local path="$1"
    local label="$2"

    if [ ! -f "$path" ]; then
        log "Skipping $label (not found)."
        return
    fi

    if command -v zsh >/dev/null 2>&1; then
        zsh "$path" || warn "$label encountered errors."
    else
        bash "$path" || warn "$label encountered errors."
    fi
}

run_powershell_script() {
    local path="$1"
    local label="$2"

    if [ ! -f "$path" ]; then
        log "Skipping $label (not found)."
        return
    fi

    if ! command -v powershell.exe >/dev/null 2>&1; then
        warn "PowerShell not available; skipping $label."
        return
    fi

    local ps_path
    ps_path=$(wslpath -w "$path")
    powershell.exe -ExecutionPolicy Bypass -NoProfile -File "$ps_path" || warn "$label encountered errors."
}

maybe_run() {
    local path="$1"
    local label="$2"

    [ -f "$path" ] || return

    if is_interactive; then
        read -p "Run $label? (y/N): " response < /dev/tty || response="N"
        [[ "$response" =~ ^[Yy]$ ]] || { echo "Skipping $label."; return; }
    else
        echo "Running non-interactively. Skipping $label."
        return
    fi

    run_script "$path" "$label"
}

export NVM_DIR="$HOME/.nvm"

load_nvm() {
    # Clear any alias/function that could block nvm's own function definition
    unalias nvm 2>/dev/null || true
    unset -f nvm 2>/dev/null || true
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
}

install_nvm() {
    if [ -d "$NVM_DIR" ]; then
        echo "NVM already present."
        return 0
    fi

    if curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash 2>/dev/null; then
        return 0
    fi

    echo "Warning: NVM installation failed; falling back to apt Node."
    return 1
}

ensure_node_via_nvm() {
    local version="${1:-22}"

    load_nvm
    if ! command -v nvm >/dev/null 2>&1; then
        echo "NVM is not available."
        return 1
    fi

    nvm install "$version" >/dev/null 2>&1 || nvm install "$version"
    nvm alias default "$version" >/dev/null 2>&1 || true
    nvm use default >/dev/null 2>&1 || true

    echo "Node via NVM: $(node -v 2>/dev/null || echo not found)"
    echo "npm: $(npm -v 2>/dev/null || echo not found)"
}

apt_node_fallback() {
    echo "Installing Node.js and npm via apt (fallback)..."
    apt_install nodejs npm

    if ! command -v node >/dev/null 2>&1 && command -v nodejs >/dev/null 2>&1; then
        sudo ln -sf "$(command -v nodejs)" /usr/bin/node
    fi

    if command -v node >/dev/null 2>&1; then
        echo "Node.js (apt): $(node -v)"
        echo "npm (apt): $(npm -v || echo missing)"
    else
        echo "Warning: Node.js installation via apt did not provide 'node' binary."
    fi
}

maybe_configure_java() {
    if ! command -v update-alternatives >/dev/null 2>&1; then
        return
    fi

    if ! sudo update-alternatives --list java >/dev/null 2>&1; then
        return
    fi

    if is_interactive; then
        read -p "Configure default Java version? (y/N): " response < /dev/tty || response="N"
        if [[ "$response" =~ ^[Yy]$ ]]; then
            sudo update-alternatives --config java
        fi
    else
        echo "Non-interactive: skipping Java version configuration."
    fi
}

ensure_winget_app() {
    local id="$1"
    local label="$2"

    if ! command -v cmd.exe >/dev/null 2>&1; then
        return
    fi

    if cmd.exe /c "winget list --id $id" >/dev/null 2>&1; then
        echo "$label is already installed."
    else
        cmd.exe /c "winget install --id $id --silent --accept-package-agreements --accept-source-agreements --wait" || \
            echo "Warning: $label installation via winget failed."
    fi
}

install_starship() {
    if command -v starship >/dev/null 2>&1; then
        log "Starship already installed."
        return 0
    fi

    if apt_install starship 2>/dev/null; then
        if command -v starship >/dev/null 2>&1; then
            log "Starship installed via apt."
            return 0
        fi
    fi

    if curl -fsSL https://starship.rs/install.sh | sh -s -- -y; then
        log "Starship installed via official script."
        return 0
    fi

    warn "Starship installation failed."
    return 1
}

# --- 3. OS Check ---
if [ ! -f /etc/debian_version ]; then
    echo "Error: This bootstrap script is tailored for Debian/Ubuntu."
    exit 1
fi

# --- 4. Repositories & Updates ---
section "Updating package sources"
sudo apt update
sudo apt upgrade -y
sudo apt autoremove -y

# --- 5. System layer (apt) ---
section "Installing system packages (apt layer)"
apt_install \
    zsh build-essential btop curl file git wget zip lsb-release \
    libsecret-1-dev ca-certificates gnupg

# --- 6. Modern shell layer ---
section "Installing modern shell tools"
apt_install yadm direnv
install_starship || true

# --- 6b. fzf (GitHub installer) ---
section "Installing fzf from GitHub"
install_fzf_from_github || true

# --- 7. Java & build layer (System Java) ---
section "Installing Java and Maven (system packages)"
apt_install openjdk-17-jdk maven
log "OpenJDK 17 and Maven installed via apt."
maybe_configure_java

# --- 8. Node.js (NVM-first) ---
section "Installing Node.js via NVM"
install_nvm && ensure_node_via_nvm 22 || apt_node_fallback

# --- 9. Tool-specific scripts ---
section "Running local setup scripts"
required_scripts=(
    "$HOME/.local/bin/minconda_install.sh:Miniconda install"
    "$HOME/.local/bin/python_interps.sh:Python interpreters setup"
    "$HOME/.local/bin/nerd_fonts_install.sh:Nerd Fonts install"
)

optional_scripts=(
    "$HOME/.local/bin/ollama_install.sh:Ollama"
    "$HOME/.local/bin/spark_install.sh:Spark"
    "$HOME/.local/bin/gcloud_install_init.sh:Google Cloud SDK"
)

# Add Windows PowerShell scripts if in WSL/Windows environment
if [ -d "/mnt/c/Windows" ] || command -v powershell.exe >/dev/null 2>&1; then
    required_scripts+=(
        "$HOME/.local/bin/starship_install_windows.ps1:Starship Windows installation"
        "$HOME/.local/bin/mobaxterm_install.ps1:MobaXterm installation"
    )
fi

for entry in "${required_scripts[@]}"; do
    path=${entry%%:*}
    label=${entry#*:}
    
    # Check if it's a PowerShell script
    if [[ "$path" == *.ps1 ]]; then
        run_powershell_script "$path" "$label"
    else
        run_script "$path" "$label"
    fi
done

for entry in "${optional_scripts[@]}"; do
    path=${entry%%:*}
    label=${entry#*:}
    maybe_run "$path" "$label"
done

# --- 10. Windows interop (WSL) ---
if [ -d "/mnt/c/Windows" ] || command -v cmd.exe >/dev/null 2>&1; then
    section "WSL: checking Windows installs via winget"

    ensure_winget_app Microsoft.VisualStudioCode "VS Code"
    
    # Install Starship on Windows first, before configuring PowerShell
    if command -v cmd.exe >/dev/null 2>&1; then
        echo "Installing Starship on Windows..."
        ensure_winget_app Starship.Starship "Starship" || true
    fi
    
    # Configure Starship in PowerShell 5.1 profile
    if command -v powershell.exe >/dev/null 2>&1; then
        echo "Configuring Starship for PowerShell 5.1..."
        powershell.exe -NoProfile -Command '
                # Enable script execution for CurrentUser
                $currentPolicy = Get-ExecutionPolicy -Scope CurrentUser
                if ($currentPolicy -eq "Restricted" -or $currentPolicy -eq "Undefined") {
                    try {
                        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
                        Write-Host "Set PowerShell execution policy to RemoteSigned for CurrentUser"
                    } catch {
                        Write-Host "Warning: Could not set execution policy. You may need to run this in an elevated PowerShell:"
                        Write-Host "  Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser"
                    }
                }
                
                $profilePath = $PROFILE.CurrentUserCurrentHost
                Write-Host "PowerShell 5.1 profile path: $profilePath"
                $profileDir = Split-Path -Parent $profilePath
                if (-not (Test-Path $profileDir)) {
                    New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
                    Write-Host "Created profile directory: $profileDir"
                }
                if (-not (Test-Path $profilePath)) {
                    New-Item -ItemType File -Path $profilePath -Force | Out-Null
                    Write-Host "Created profile file at $profilePath"
                }
                $starshipInit = "Invoke-Expression (&starship init powershell)"
                $content = if (Test-Path $profilePath) { Get-Content $profilePath -Raw } else { "" }
                if ($content -notmatch "starship init") {
                    Add-Content -Path $profilePath -Value "`n$starshipInit"
                    Write-Host "Added Starship initialization to PowerShell profile"
                } else {
                    Write-Host "Starship already configured in PowerShell profile"
                }
            ' || echo "Note: PowerShell 5.1 profile configuration failed (manual setup may be needed)."
    fi

    # Configure Starship in PowerShell 7+ profile (if available)
    if command -v pwsh.exe >/dev/null 2>&1; then
        echo "Configuring Starship for PowerShell 7+..."
        pwsh.exe -NoProfile -Command '
                # Enable script execution for CurrentUser
                $currentPolicy = Get-ExecutionPolicy -Scope CurrentUser
                if ($currentPolicy -eq "Restricted" -or $currentPolicy -eq "Undefined") {
                    try {
                        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
                        Write-Host "Set PowerShell execution policy to RemoteSigned for CurrentUser"
                    } catch {
                        Write-Host "Warning: Could not set execution policy for PowerShell 7+."
                    }
                }
                
                $profilePath = $PROFILE.CurrentUserCurrentHost
                Write-Host "PowerShell 7+ profile path: $profilePath"
                $profileDir = Split-Path -Parent $profilePath
                if (-not (Test-Path $profileDir)) {
                    New-Item -ItemType Directory -Path $profileDir -Force | Out-Null
                    Write-Host "Created profile directory: $profileDir"
                }
                if (-not (Test-Path $profilePath)) {
                    New-Item -ItemType File -Path $profilePath -Force | Out-Null
                    Write-Host "Created profile file at $profilePath"
                }
                $starshipInit = "Invoke-Expression (&starship init powershell)"
                $content = if (Test-Path $profilePath) { Get-Content $profilePath -Raw } else { "" }
                if ($content -notmatch "starship init") {
                    Add-Content -Path $profilePath -Value "`n$starshipInit"
                    Write-Host "Added Starship initialization to PowerShell 7+ profile"
                } else {
                    Write-Host "Starship already configured in PowerShell 7+ profile"
                }
            ' || echo "Note: PowerShell 7+ profile configuration failed (manual setup may be needed)."
    fi

    # Copy Starship config from WSL to Windows
    if [ -f "$HOME/.config/starship.toml" ]; then
        echo "Copying Starship config from WSL to Windows..."
        powershell.exe -NoProfile -Command "
            \$wslConfigPath = \"\\\\wsl\\\$\\Ubuntu\\home\\\$env:USERNAME\\.config\\starship.toml\"
            Write-Host \"WSL Starship config path: \$wslConfigPath\"
            # Use \$env:APPDATA for standard Starship config location on Windows
            \$windowsConfigDir = Join-Path \$env:APPDATA 'starship'
            \$windowsConfigPath = Join-Path \$windowsConfigDir 'starship.toml'
            
            if (Test-Path \$wslConfigPath) {
                if (-not (Test-Path \$windowsConfigDir)) {
                    New-Item -ItemType Directory -Path \$windowsConfigDir -Force | Out-Null
                    Write-Host \"Created Starship config directory: \$windowsConfigDir\"
                }
                Copy-Item -Path \$wslConfigPath -Destination \$windowsConfigPath -Force
                Write-Host \"Copied Starship config to Windows: \$windowsConfigPath\"
            } else {
                Write-Host \"WSL Starship config not found at \$wslConfigPath\"
            }
        " || echo "Warning: Failed to copy Starship config to Windows."
    fi

    if command -v cmd.exe >/dev/null 2>&1; then
        if ! cmd.exe /c "where docker" >/dev/null 2>&1; then
            if is_interactive; then
                read -p "Install Docker Desktop? (y/N): " response < /dev/tty || response="N"
                if [[ "$response" =~ ^[Yy]$ ]]; then
                    cmd.exe /c "winget install --id Docker.DockerDesktop --silent --accept-package-agreements --accept-source-agreements --wait" || \
                        echo "Warning: Docker Desktop installation via winget failed."
                    echo ""
                    echo "=== Docker Desktop Installation Complete ==="
                    echo "IMPORTANT: Restart Windows for Docker to function."
                else
                    echo "Skipping Docker Desktop installation."
                fi
            else
                echo "Non-interactive: skipping Docker Desktop installation."
            fi
        else
            echo "Docker is already installed."
        fi
    fi
fi

# --- 11. Final configs & shell ---
section "Final configuration"
git config --global core.excludesfile "$HOME/.config/git/ignore" || echo "Warning: Failed to set git config."

if command -v zsh >/dev/null 2>&1; then
    current_shell=$(getent passwd "$USER" | cut -d: -f7)
    zsh_path=$(command -v zsh)

    if [ "$current_shell" != "$zsh_path" ]; then
        echo "Changing your default shell to zsh..."
        if sudo chsh -s "$zsh_path" "$USER"; then
            echo "Shell successfully changed to zsh."
        else
            echo "Warning: Failed to change shell. You may need to run 'chsh -s $(which zsh)' manually."
        fi
    else
        echo "Default shell is already zsh."
    fi
else
    echo "Warning: zsh not found. Please install it manually before continuing."
fi

echo "--------------------------------------------------"
echo "Bootstrap complete!"
echo "Please RESTART your terminal (or log out and back in) to use ZSH."
echo "--------------------------------------------------"
