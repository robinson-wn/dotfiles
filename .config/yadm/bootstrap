#!/bin/bash

# Add apt repos
# helm
if [ ! -f /usr/share/keyrings/helm.gpg ]; then
    curl -fsSL https://baltocdn.com/helm/signing.asc | sudo gpg --dearmor -o /usr/share/keyrings/helm.gpg
    echo "deb [signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
fi

# Ensure apt is up to date
sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y

bash ~/.local/bin/homebrew_install.sh
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# Linux apt installs
sudo apt install -y openjdk-17-jdk openjdk-21-jdk maven
sudo apt install -y zsh
sudo update-alternatives --config java
sudo apt install -y build-essential btop curl file git duf eza gh glab yadm bat direnv wget yamllint zoxide
sudo apt install -y docker.io
sudo apt install -y kubectl kubectx

# Linux utility brew installs (only used when apt or other install not simple)
if command -v brew >/dev/null; then
    brew install bottom dust starship
fi

# Install fzf from upstream (keeps newer features than distro package)
if [ ! -d "$HOME/.fzf" ]; then
	git clone --depth 1 https://github.com/junegunn/fzf.git "$HOME/.fzf"
	"$HOME/.fzf/install" --no-update-rc
else
	printf "fzf already installed in $HOME/.fzf\n"
fi

run_opt_script() {
    local script_path=$1
    local script_name=$2
    read -p "Do you want to run $script_name? (y/N): " response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        bash "$script_path"
    fi
}

bash ~/.local/bin/minconda_install.sh
bash ~/.local/bin/python_interps.sh

# Linux brew spark fails (don't use it)
run_opt_script "$HOME/.local/bin/spark_install.sh" "Spark"
run_opt_script "$HOME/.local/bin/gcloud_install_init.sh" "Google Cloud"

bash ~/.local/bin/ollama_install.sh

# Initial configs
git config --global core.excludesfile ~/.config/git/ignore

# Windows installs
PS_PATH="/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"
# Verify Interop is enabled in the kernel
if [ -x "$PS_PATH" ] && grep -q "enabled" /proc/sys/fs/binfmt_misc/status 2>/dev/null; then
    echo "Running Windows-side installers..."

    # We use local variables to ensure wslpath succeeds before passing to PowerShell
    VS_CODE_WIN=$(wslpath -w "$HOME/.local/bin/vscode_install.ps1")
    NERD_WIN=$(wslpath -w "$HOME/.local/bin/nerd_fonts_install.ps1")
    DOCKER_WIN=$(wslpath -w "$HOME/.local/bin/docker_install.ps1")

    "$PS_PATH" -ExecutionPolicy Bypass -File "$VS_CODE_WIN"
    "$PS_PATH" -ExecutionPolicy Bypass -File "$NERD_WIN"
    "$PS_PATH" -ExecutionPolicy Bypass -File "$DOCKER_WIN"
else
    echo "Skipping Windows installs: PowerShell not found or Interop disabled."
    echo "Hint: Check /proc/sys/fs/binfmt_misc/status"
fi
